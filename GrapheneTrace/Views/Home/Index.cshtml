@* This line is critical: it prevents the page from inheriting the shared layout (_Layout.cshtml) *@
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphene Trace: Login Portal</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Firebase/Firestore Imports (Required for auth setup, even if mocked) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions globally for the main script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            getFirestore,
            setLogLevel
        };
    </script>
</head>
<body class="bg-white text-gray-800 font-sans min-h-screen flex items-center justify-center">

    <!-- Main Application Container -->
    <div id="app-container" class="w-full h-full">
        <!-- Login UI will be rendered here -->
    </div>
    
    <!-- NOTE: We use jQuery for form handling and AJAX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // --- FIREBASE SETUP ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        async function initializeFirebase() {
            if (firebaseConfig) {
                try {
                    const app = firebase.initializeApp(firebaseConfig);
                    const auth = firebase.getAuth(app);
                    firebase.getFirestore(app);

                    if (initialAuthToken) {
                        await firebase.signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await firebase.signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                }
            }
        }

        // --- MOCK AUTHENTICATION & REDIRECTION LOGIC ---
        function handleLogin(username, password) {
            let redirectUrl = null;
            
            // Determine the target file/URL based on the user role
            if (username === 'patient') {
                redirectUrl = '/Home/Patient';
            } 
            else if (username === 'clinician' || username === 'doctor') {
                redirectUrl = '/Home/Clinician'; 
            } 
            else if (username === 'admin') {
                redirectUrl = '/Home/Admin';
            } else {
                showModal("Login Failed", "Invalid Credentials. Please use 'patient', 'clinician', or 'admin' as the User ID to log in.");
                return;
            }

            // Perform the full browser redirection
            window.location.href = redirectUrl;
        }

        // --- CUSTOM MODAL FOR ALERTS ---
        function showModal(title, message) {
            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                        <h3 class="text-xl font-bold text-red-600 mb-4">${title}</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="$('#custom-modal').remove()" 
                                class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            `;
            $('body').append(modalHtml);
        }

        // --- LOGIN PAGE RENDER (The guaranteed render function) ---
        function renderLoginPage() {
            // HTML structure to match your screenshot design
            return `
                <div class="fixed inset-0 bg-white flex w-full h-full">
                    <div class="bg-white flex w-full h-full">
                        <div class="w-full sm:w-2/5 lg:w-1/3 h-full px-12 py-10 flex flex-col justify-between">
                            <div>
                                <div class="mt-20"> 
                                    <h1 class="text-4xl font-bold text-gray-800 mb-1">Log in to</h1>
                                    <h1 class="text-4xl font-bold text-gray-800 mb-10">Graphene Trace Portal</h1>
                                </div>
                                
                                <p class="text-gray-500 mb-4 font-semibold text-sm tracking-widest">Credentials</p>
                                
                                <form id="login-form" class="space-y-6">
                                    <div class="space-y-2">
                                        <label for="user_id" class="block text-xs font-medium text-gray-600">User ID</label>
                                        <input type="text" id="user_id" name="user_id" required 
                                            class="w-full px-3 py-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-base shadow-sm">
                                    </div>
                                    <div class="space-y-2">
                                        <label for="password" class="block text-xs font-medium text-gray-600">Password</label>
                                        <input type="password" id="password" name="password" required 
                                            class="w-full px-3 py-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-base shadow-sm">
                                    </div>
                                    
                                    <div class="pt-6 space-y-2 flex flex-col items-start">
                                        <button type="submit" 
                                            class="w-32 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 text-base">
                                            Login
                                        </button>
                                        <a href="#" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150 mt-4">Forgot Password?</a>
                                    </div>
                                </form>
                            </div>
                            <div></div> 
                        </div>

                        <!-- Right Panel (Empty White Area) -->
                        <div class="flex-grow bg-white border-l border-gray-100 relative">
                            <div class="absolute bottom-4 right-6 text-xs text-gray-400">
                                &copy; 2025 - sample - Privacy
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- DOCUMENT READY & INITIALIZATION (The ultimate fix) ---
        $(document).ready(function(){
            // 1. Initialize Firebase (async process)
            initializeFirebase(); 

            // 2. Render the login page HTML immediately after the DOM is ready
            $('#app-container').html(renderLoginPage());

            // 3. Set up event listener for the login form submission
            $(document).on('submit', '#login-form', function(e) {
                e.preventDefault();
                const username = $('#user_id').val().toLowerCase();
                const password = $('#password').val(); 
                handleLogin(username, password);
            });
        });
    </script>
</body>
</html>
